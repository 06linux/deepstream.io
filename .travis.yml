sudo: true
language: node_js

before_install:
  - gem install fpm --conservative || echo "FPM install failed"
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      if [ "$CC" == "gcc" ]; then
        export CC=$(ls -t /usr/local/bin/gcc-?.?);
      fi
    fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export CXX=g++-4.8;
    fi

compiler:
  - gcc
  - clang

node_js:
  - "8"
  - "6.11"
  - "4"

env:
  - DEFAULT_DELAY: 50

matrix:
  include:
    - node_js: "6.11"
      os: osx

script:
  # This fails on node 4
  - if [[ "$TRAVIS_NODE_VERSION" == "6.11"* ]]; then
      npm run lint;
    fi
  - npm run reporter
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      sh scripts/run-e2e.sh;
    fi
  # This has to happen here and not in before_deploy to be put in travis cache
  - bash ./scripts/package.sh

cache:
  directories:
    - nexe_node

deploy:
  - provider: s3
    access_key_id:
      secure: "TBol5tGfseN7d2+AMKmGOkbMdFSPH4V1DAmtj//oKrbh33u6rVsCCgtDf6tmUV+TbgRJ3pElFQclBHTexSse9mO1piqQB2n5L62Cg1AckGfI58iUEYTa26d4TN0CsnUjq2VHfp4jfiS//xudxCQFj+3C2OIiEyEk6cFldjeKSpYsb2INmz1H3Lyll0HSZXH6EZbDuoKTTlfLJ7yqToUyO1+sMwW8xtcn2iWBbVbcg/qDkf0P6+q0YOni2QCCxYJkVvHirZo8IHTYwOcpGkLITdkewHBFPo6pONgoO0Fwo2wtb8auXyNva8xJk89VoFwvMWXZHUyq1wbcYSnL/snpdfH5FOaXPlsicBrvEFG3gytpcbAW1l4aAQy7XpwApHV/LiWLmYmdL5CiYrtWAqCPONsOTGr657sLtXE7qQdKdkrIaXhiPKM+njIvAJJOiFvzj94GhgQQ64z9FHfBp1/VgJLlXH+mzZmCrrJU02/IdLhlvHja9EEYbn6L3j9+UcPQfmmDglumJfZfBJf/dHF05x1sD43eniu6WJLqTTvxm1ZYDigJph6AoXldmUer4E9DlHaUtP/UBWvgQgdkfrbsX32OFgvnq1VwOWFsuLvXLMrsUu04Y7G8KGVwEfqRJFPStLYIUYMRD9iZXDjvOH7w4Yb8H33QWScq0ycMwSoZok0="
    secret_access_key:
      secure: "Uu+5ZjtZNj967bgboPw7Pz38/4/uUOhrT6C2jnC0/upODILyjZrTHmIdxvftUU3X+NgHDkJoqsC7blgxQhs4XtuLD1PC49zfUB5afurXNTPRbKJTbfC8DEZ6OThNWJiuXSkEE6odHSTno1OlKYkbX41Oomagy3vCwsfJZ7fGKVG6gHTDvQmfbaVK9kUGlKbOwOYQWeBMI3PfU5xcMgCwzss/i5qJoFTYrMPRpLg+D0YJjIPRoen6x9cEquFBX7OHQ8nAGQzb0LanIam3rAhyCea/dXQN8nDS4zk7rNP54HlABULbKcruyYX+4cQGCjI41lOJdQk+UKv9VZRYqoowjo9nr+Zg7AsYT83TnTlJwsuZDtGD/nuyAfdSwUblvtCLjdO4rAzoIxeNKR11FiLmI6pVL6RXArthAscAWv3RU8YmeR1eZTqmtvnLxwZxAkqOlgegPkg+4MFKiJobyHdNEDAfIN34GMhXBRjyWVwAXk/OHWAeBkP5IDNrb6lIFxtK6VY/dHo3v02u+tcowZiKWy+WoPEHlbPZmqV4i/7/h2OpJZaRElzuyySiJZB3/G73HgJCr+9GwNs/vmgNHUCbMeYdVIwDBw3OWWS7J6o5vgsg91R7l8WwBzkE3dUhrLUkxaH1p7inTs6ri26QNoixNzKyxYlkZckfZMEtPqXNwTs="
    bucket: ds-server-artifacts
    skip_cleanup: true
    acl: public_read
    local_dir: build
    upload-dir: $TRAVIS_REPO_SLUG
    region: us-east-1
    on:
      branch: master
  - provider: s3
    access_key_id:
      secure: "I18K+fcvIuH2qg7eow0PtBC7J5oenf/w3SmmKpCl/Cr7oLcs7Qb92Dbmw/7TCTL5OaRvGyJ7QjaVpFjFhcEoB30WZvyth/qs8oTZb5qSPXQlRepto39Qj5vRef0ICpMgxGHYYCm7fLI+8YMWQgEF4SjKUgxeobo6WYATu+c9aD0c9xJtMFcwQWmtHKhln5ao4A4a0vYPDWz1AGJIiWqpSJjsUNWx6pa5F7UwPT7ZnzA3eKFvJVftgI/aFaowpUhrkrJ57rVjVkKJm30ny/gSc1BT++TdpQGAjwXPZrZsSmLzJjJYA2SEOEA5+D3BfrnI/HjQRWya+zWjkCrX5LOzb2uUU2cRRgtBCYBdLmoopiu373A5HNZ3BkNlXa1qPmUxCkZ2CL19FjXp4sdXDHjyL3qrT+gaWS2KF+w9DsITdVELm9cKMLEppCCrZfA3CRXxZogo8X0hiYqkHcpLNTDKDgRvsoIH9fwgAB8wHUHjwHFev5WQ188Pz1hAaPkWs/vKvOBgO/ykM52ZXF4cF9ewHJ1tcfert5Yvo4rxFxDNZGlMRDZB1zYXJ96oVlyit+7kiwRs/XFD5/zOQP7gklyFCfyQgfR2UoFM0Jwm4RbC2rB1I+MIKCMqQe7+QxeLyUMsYOWasHcsJf8y7L3HDY+UW56GOPywJr6+D5IQuko4SWk="
    secret_access_key:
      secure: "rqiM7mKGiQuyX+0XOHas6j/VdmqKSnXzSE0p/CtWM+CeEE/W5a468GWR+MF+SdLGitHXB/9pEBmvNuJidWdlcdY1IQtbKB15ByetYbBsPI9mITsjqy1i+VUXMc+t7/im89KLjaqSHHbzwd9fKwLWjUbJVyrgxOSxWYM6ZJphBf/6BichRjevPxdifm38mLGfvGR44zkihpFmttaQaOthxwzJ5faClVHqk4zfv+XxVUCDM9vitsAkNsoWzXEsBdBWn3bocC3kTvpPo1cyclHR21iGJwNhaA6oefmyEBfTLCSRdHmwehhm2CGR7FjY8s2KsAe66E4lV9fcnVmEUCu+0GAw+5MurNj8PSYQAYZhu/oKG87Q+Njp6sicPtu0AaNb9D7wkMjUrTbQcFoH4vF0Y5OQl3VRIIc9yj0vBQFMrzHmK9ETSTDXkpB32Xwhm1tVQeb5v7/eJrlHqMxutReHSO4mPsLB8CNWa9wH8VoAtm4mEWp4Ub8TOWPBuT86byuCuT1g3XSeeMhO7DxjtSJsdZfHYaywmhZQg0sp4d/61VGtoDNgLudAw+XB62N+eFEYAtCthPm8vJlOCbhV/La57IXDXt8oWne3peuBkJGtk0WZsL202+geDJeZrBoZ4UXpWcZ8QZ3TN+v8z0MA9Rkqd/W9kfnaIWOXqmI6k8ugP3I="
    bucket: dsx-server-artifacts
    skip_cleanup: true
    acl: public_read
    local_dir: build
    upload-dir: $TRAVIS_REPO_SLUG
    on:
      tags: true

services:
  - redis-server

addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - rpm

notifications:
  email: false
